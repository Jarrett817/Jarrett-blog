import{_ as s,c as n,o as a,Q as l}from"./chunks/framework.7454da9a.js";const m=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"front-end/micro-front/index.md","filePath":"front-end/micro-front/index.md","lastUpdated":1712240776000}'),p={name:"front-end/micro-front/index.md"},o=l(`<h2 id="qiankun-是怎么做-js-隔离的" tabindex="-1">qiankun 是怎么做 js 隔离的 <a class="header-anchor" href="#qiankun-是怎么做-js-隔离的" aria-label="Permalink to &quot;qiankun 是怎么做 js 隔离的&quot;">​</a></h2><p>sandbox，参数默认为 true，对于 js 隔离，默认使用 proxy 沙箱，有个文档上没写的隐藏参数 loose，区分使用 legacySandbox 和 proxySandbox</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki solarized-dark"><code><span class="line"><span style="color:#93A1A1;font-weight:bold;">type</span><span style="color:#839496;"> </span><span style="color:#CB4B16;">QiankunSpecialOpts</span><span style="color:#839496;"> </span><span style="color:#859900;">=</span><span style="color:#839496;"> {</span></span>
<span class="line"><span style="color:#839496;">  </span><span style="color:#586E75;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#586E75;font-style:italic;">   * </span><span style="color:#93A1A1;font-weight:bold;">@deprecated</span><span style="color:#586E75;font-style:italic;"> internal api, don&#39;t used it as normal, might be removed after next version</span></span>
<span class="line"><span style="color:#586E75;font-style:italic;">   */</span></span>
<span class="line"><span style="color:#839496;">  $$cacheLifecycleByAppName</span><span style="color:#859900;">?:</span><span style="color:#839496;"> </span><span style="color:#859900;">boolean</span><span style="color:#839496;">;</span></span>
<span class="line"><span style="color:#839496;">  prefetch</span><span style="color:#859900;">?:</span><span style="color:#839496;"> </span><span style="color:#CB4B16;">PrefetchStrategy</span><span style="color:#839496;">;</span></span>
<span class="line"><span style="color:#839496;">  sandbox</span><span style="color:#859900;">?:</span></span>
<span class="line"><span style="color:#839496;">    </span><span style="color:#859900;">|</span><span style="color:#839496;"> </span><span style="color:#859900;">boolean</span></span>
<span class="line"><span style="color:#839496;">    </span><span style="color:#859900;">|</span><span style="color:#839496;"> {</span></span>
<span class="line"><span style="color:#839496;">        strictStyleIsolation</span><span style="color:#859900;">?:</span><span style="color:#839496;"> </span><span style="color:#859900;">boolean</span><span style="color:#839496;">;</span></span>
<span class="line"><span style="color:#839496;">        experimentalStyleIsolation</span><span style="color:#859900;">?:</span><span style="color:#839496;"> </span><span style="color:#859900;">boolean</span><span style="color:#839496;">;</span></span>
<span class="line"><span style="color:#839496;">        </span><span style="color:#586E75;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#586E75;font-style:italic;">         * </span><span style="color:#93A1A1;font-weight:bold;">@deprecated</span><span style="color:#586E75;font-style:italic;"> We use strict mode by default</span></span>
<span class="line"><span style="color:#586E75;font-style:italic;">         */</span></span>
<span class="line"><span style="color:#839496;">        loose</span><span style="color:#859900;">?:</span><span style="color:#839496;"> </span><span style="color:#859900;">boolean</span><span style="color:#839496;">;</span></span>
<span class="line"><span style="color:#839496;">        </span><span style="color:#586E75;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#586E75;font-style:italic;">         * use speed sandbox mode, enabled by default from 2.9.0</span></span>
<span class="line"><span style="color:#586E75;font-style:italic;">         */</span></span>
<span class="line"><span style="color:#839496;">        speedy</span><span style="color:#859900;">?:</span><span style="color:#839496;"> </span><span style="color:#859900;">boolean</span><span style="color:#839496;">;</span></span>
<span class="line"><span style="color:#839496;">        patchers</span><span style="color:#859900;">?:</span><span style="color:#839496;"> </span><span style="color:#CB4B16;">Patcher</span><span style="color:#839496;">[];</span></span>
<span class="line"><span style="color:#839496;">      };</span></span>
<span class="line"><span style="color:#839496;">  </span><span style="color:#586E75;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#586E75;font-style:italic;">    with singular mode, any app will wait to load until other apps are unmouting</span></span>
<span class="line"><span style="color:#586E75;font-style:italic;">    it is useful for the scenario that only one sub app shown at one time</span></span>
<span class="line"><span style="color:#586E75;font-style:italic;">  */</span></span>
<span class="line"><span style="color:#839496;">  singular</span><span style="color:#859900;">?:</span><span style="color:#839496;"> </span><span style="color:#859900;">boolean</span><span style="color:#839496;"> </span><span style="color:#859900;">|</span><span style="color:#839496;"> ((app</span><span style="color:#859900;">:</span><span style="color:#839496;"> </span><span style="color:#CB4B16;">LoadableApp</span><span style="color:#839496;">&lt;</span><span style="color:#859900;">any</span><span style="color:#839496;">&gt;) </span><span style="color:#93A1A1;font-weight:bold;">=&gt;</span><span style="color:#839496;"> </span><span style="color:#CB4B16;">Promise</span><span style="color:#839496;">&lt;</span><span style="color:#859900;">boolean</span><span style="color:#839496;">&gt;);</span></span>
<span class="line"><span style="color:#839496;">  </span><span style="color:#586E75;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#586E75;font-style:italic;">   * skip some scripts or links intercept, like JSONP</span></span>
<span class="line"><span style="color:#586E75;font-style:italic;">   */</span></span>
<span class="line"><span style="color:#839496;">  </span><span style="color:#268BD2;">excludeAssetFilter</span><span style="color:#859900;">?:</span><span style="color:#839496;"> (url</span><span style="color:#859900;">:</span><span style="color:#839496;"> </span><span style="color:#859900;">string</span><span style="color:#839496;">) </span><span style="color:#93A1A1;font-weight:bold;">=&gt;</span><span style="color:#839496;"> </span><span style="color:#859900;">boolean</span><span style="color:#839496;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#839496;">  globalContext</span><span style="color:#859900;">?:</span><span style="color:#839496;"> </span><span style="color:#859900;">typeof</span><span style="color:#839496;"> </span><span style="color:#268BD2;">window</span><span style="color:#839496;">;</span></span>
<span class="line"><span style="color:#839496;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki solarized-dark"><code><span class="line"><span style="color:#93A1A1;font-weight:bold;">const</span><span style="color:#839496;"> </span><span style="color:#268BD2;">useLooseSandbox</span><span style="color:#839496;"> </span><span style="color:#859900;">=</span><span style="color:#839496;"> </span><span style="color:#859900;">typeof</span><span style="color:#839496;"> </span><span style="color:#268BD2;">sandbox</span><span style="color:#839496;"> </span><span style="color:#859900;">===</span><span style="color:#839496;"> </span><span style="color:#2AA198;">&#39;object&#39;</span><span style="color:#839496;"> </span><span style="color:#859900;">&amp;&amp;</span><span style="color:#839496;"> </span><span style="color:#859900;">!!</span><span style="color:#268BD2;">sandbox</span><span style="color:#839496;">.</span><span style="color:#268BD2;">loose</span><span style="color:#839496;">;</span></span>
<span class="line"><span style="color:#586E75;font-style:italic;">// enable speedy mode by default</span></span>
<span class="line"><span style="color:#93A1A1;font-weight:bold;">const</span><span style="color:#839496;"> </span><span style="color:#268BD2;">speedySandbox</span><span style="color:#839496;"> </span><span style="color:#859900;">=</span><span style="color:#839496;"> </span><span style="color:#859900;">typeof</span><span style="color:#839496;"> </span><span style="color:#268BD2;">sandbox</span><span style="color:#839496;"> </span><span style="color:#859900;">===</span><span style="color:#839496;"> </span><span style="color:#2AA198;">&#39;object&#39;</span><span style="color:#839496;"> </span><span style="color:#859900;">?</span><span style="color:#839496;"> </span><span style="color:#268BD2;">sandbox</span><span style="color:#839496;">.</span><span style="color:#268BD2;">speedy</span><span style="color:#839496;"> </span><span style="color:#859900;">!==</span><span style="color:#839496;"> </span><span style="color:#B58900;">false</span><span style="color:#839496;"> </span><span style="color:#859900;">:</span><span style="color:#839496;"> </span><span style="color:#B58900;">true</span><span style="color:#839496;">;</span></span>
<span class="line"><span style="color:#93A1A1;font-weight:bold;">let</span><span style="color:#839496;"> </span><span style="color:#268BD2;">sandboxContainer</span><span style="color:#839496;">;</span></span>
<span class="line"><span style="color:#859900;">if</span><span style="color:#839496;"> (</span><span style="color:#268BD2;">sandbox</span><span style="color:#839496;">) {</span></span>
<span class="line"><span style="color:#839496;">  </span><span style="color:#268BD2;">sandboxContainer</span><span style="color:#839496;"> </span><span style="color:#859900;">=</span><span style="color:#839496;"> </span><span style="color:#268BD2;">createSandboxContainer</span><span style="color:#839496;">(</span></span>
<span class="line"><span style="color:#839496;">    </span><span style="color:#268BD2;">appInstanceId</span><span style="color:#839496;">,</span></span>
<span class="line"><span style="color:#839496;">    </span><span style="color:#586E75;font-style:italic;">// FIXME should use a strict sandbox logic while remount, see https://github.com/umijs/qiankun/issues/518</span></span>
<span class="line"><span style="color:#839496;">    </span><span style="color:#268BD2;">initialAppWrapperGetter</span><span style="color:#839496;">,</span></span>
<span class="line"><span style="color:#839496;">    </span><span style="color:#268BD2;">scopedCSS</span><span style="color:#839496;">,</span></span>
<span class="line"><span style="color:#839496;">    </span><span style="color:#268BD2;">useLooseSandbox</span><span style="color:#839496;">,</span></span>
<span class="line"><span style="color:#839496;">    </span><span style="color:#268BD2;">excludeAssetFilter</span><span style="color:#839496;">,</span></span>
<span class="line"><span style="color:#839496;">    </span><span style="color:#268BD2;">global</span><span style="color:#839496;">,</span></span>
<span class="line"><span style="color:#839496;">    </span><span style="color:#268BD2;">speedySandbox</span></span>
<span class="line"><span style="color:#839496;">  );</span></span>
<span class="line"><span style="color:#839496;">  </span><span style="color:#586E75;font-style:italic;">// 用沙箱的代理对象作为接下来使用的全局对象</span></span>
<span class="line"><span style="color:#839496;">  </span><span style="color:#268BD2;">global</span><span style="color:#839496;"> </span><span style="color:#859900;">=</span><span style="color:#839496;"> </span><span style="color:#268BD2;">sandboxContainer</span><span style="color:#839496;">.</span><span style="color:#268BD2;">instance</span><span style="color:#839496;">.</span><span style="color:#268BD2;">proxy</span><span style="color:#839496;"> </span><span style="color:#859900;">as</span><span style="color:#839496;"> </span><span style="color:#859900;">typeof</span><span style="color:#839496;"> </span><span style="color:#268BD2;">window</span><span style="color:#839496;">;</span></span>
<span class="line"><span style="color:#839496;">  </span><span style="color:#268BD2;">mountSandbox</span><span style="color:#839496;"> </span><span style="color:#859900;">=</span><span style="color:#839496;"> </span><span style="color:#268BD2;">sandboxContainer</span><span style="color:#839496;">.</span><span style="color:#268BD2;">mount</span><span style="color:#839496;">;</span></span>
<span class="line"><span style="color:#839496;">  </span><span style="color:#268BD2;">unmountSandbox</span><span style="color:#839496;"> </span><span style="color:#859900;">=</span><span style="color:#839496;"> </span><span style="color:#268BD2;">sandboxContainer</span><span style="color:#839496;">.</span><span style="color:#268BD2;">unmount</span><span style="color:#839496;">;</span></span>
<span class="line"><span style="color:#839496;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>qinakun 在创建沙箱时有以下代码</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki solarized-dark"><code><span class="line"><span style="color:#93A1A1;font-weight:bold;">function</span><span style="color:#839496;"> </span><span style="color:#268BD2;">createSandboxContainer</span><span style="color:#839496;">(</span></span>
<span class="line"><span style="color:#839496;">  appName</span><span style="color:#859900;">:</span><span style="color:#839496;"> </span><span style="color:#859900;">string</span><span style="color:#839496;">,</span></span>
<span class="line"><span style="color:#839496;">  </span><span style="color:#268BD2;">elementGetter</span><span style="color:#859900;">:</span><span style="color:#839496;"> () </span><span style="color:#93A1A1;font-weight:bold;">=&gt;</span><span style="color:#839496;"> </span><span style="color:#CB4B16;">HTMLElement</span><span style="color:#839496;"> </span><span style="color:#859900;">|</span><span style="color:#839496;"> </span><span style="color:#CB4B16;">ShadowRoot</span><span style="color:#839496;">,</span></span>
<span class="line"><span style="color:#839496;">  scopedCSS</span><span style="color:#859900;">:</span><span style="color:#839496;"> </span><span style="color:#859900;">boolean</span><span style="color:#839496;">,</span></span>
<span class="line"><span style="color:#839496;">  useLooseSandbox</span><span style="color:#859900;">?:</span><span style="color:#839496;"> </span><span style="color:#859900;">boolean</span><span style="color:#839496;">,</span></span>
<span class="line"><span style="color:#839496;">  </span><span style="color:#268BD2;">excludeAssetFilter</span><span style="color:#859900;">?:</span><span style="color:#839496;"> (url</span><span style="color:#859900;">:</span><span style="color:#839496;"> </span><span style="color:#859900;">string</span><span style="color:#839496;">) </span><span style="color:#93A1A1;font-weight:bold;">=&gt;</span><span style="color:#839496;"> </span><span style="color:#859900;">boolean</span><span style="color:#839496;">,</span></span>
<span class="line"><span style="color:#839496;">  globalContext</span><span style="color:#859900;">?:</span><span style="color:#839496;"> </span><span style="color:#859900;">typeof</span><span style="color:#839496;"> </span><span style="color:#268BD2;">window</span><span style="color:#839496;">,</span></span>
<span class="line"><span style="color:#839496;">  speedySandBox</span><span style="color:#859900;">?:</span><span style="color:#839496;"> </span><span style="color:#859900;">boolean</span></span>
<span class="line"><span style="color:#839496;">) {</span></span>
<span class="line"><span style="color:#839496;">  </span><span style="color:#93A1A1;font-weight:bold;">let</span><span style="color:#839496;"> </span><span style="color:#268BD2;">sandbox</span><span style="color:#859900;">:</span><span style="color:#839496;"> </span><span style="color:#CB4B16;">SandBox</span><span style="color:#839496;">;</span></span>
<span class="line"><span style="color:#839496;">  </span><span style="color:#859900;">if</span><span style="color:#839496;"> (</span><span style="color:#268BD2;">window</span><span style="color:#839496;">.</span><span style="color:#268BD2;">Proxy</span><span style="color:#839496;">) {</span></span>
<span class="line"><span style="color:#839496;">    </span><span style="color:#586E75;font-style:italic;">// 如果浏览器支持Proxy，使用LegacySandBox或者ProxySandbox</span></span>
<span class="line"><span style="color:#839496;">    </span><span style="color:#268BD2;">sandbox</span><span style="color:#839496;"> </span><span style="color:#859900;">=</span><span style="color:#839496;"> </span><span style="color:#268BD2;">useLooseSandbox</span></span>
<span class="line"><span style="color:#839496;">      </span><span style="color:#859900;">?</span><span style="color:#839496;"> </span><span style="color:#859900;">new</span><span style="color:#839496;"> </span><span style="color:#268BD2;">LegacySandbox</span><span style="color:#839496;">(</span><span style="color:#268BD2;">appName</span><span style="color:#839496;">, </span><span style="color:#268BD2;">globalContext</span><span style="color:#839496;">)</span></span>
<span class="line"><span style="color:#839496;">      </span><span style="color:#859900;">:</span><span style="color:#839496;"> </span><span style="color:#859900;">new</span><span style="color:#839496;"> </span><span style="color:#268BD2;">ProxySandbox</span><span style="color:#839496;">(</span><span style="color:#268BD2;">appName</span><span style="color:#839496;">, </span><span style="color:#268BD2;">globalContext</span><span style="color:#839496;">, { speedy: </span><span style="color:#859900;">!!</span><span style="color:#268BD2;">speedySandBox</span><span style="color:#839496;"> });</span></span>
<span class="line"><span style="color:#839496;">  } </span><span style="color:#859900;">else</span><span style="color:#839496;"> {</span></span>
<span class="line"><span style="color:#839496;">    </span><span style="color:#586E75;font-style:italic;">// 否则使用SnapshotSandBox</span></span>
<span class="line"><span style="color:#839496;">    </span><span style="color:#268BD2;">sandbox</span><span style="color:#839496;"> </span><span style="color:#859900;">=</span><span style="color:#839496;"> </span><span style="color:#859900;">new</span><span style="color:#839496;"> </span><span style="color:#268BD2;">SnapshotSandbox</span><span style="color:#839496;">(</span><span style="color:#268BD2;">appName</span><span style="color:#839496;">);</span></span>
<span class="line"><span style="color:#839496;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#839496;">  </span><span style="color:#586E75;font-style:italic;">// ...</span></span>
<span class="line"><span style="color:#839496;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="快照沙箱" tabindex="-1">快照沙箱 <a class="header-anchor" href="#快照沙箱" aria-label="Permalink to &quot;快照沙箱&quot;">​</a></h3><p>基于 diff 实现，只适用单例，且会污染 window</p><p>原理：将 window 的快照信息存到 windowSnapshot 中，将应用对于 window 属性的丢该记录到 modifyPropsMap 中，加载应用时用来还原，卸载应用时还原 window</p><h3 id="代理沙箱" tabindex="-1">代理沙箱 <a class="header-anchor" href="#代理沙箱" aria-label="Permalink to &quot;代理沙箱&quot;">​</a></h3><h4 id="legacysandbox" tabindex="-1">legacySandbox <a class="header-anchor" href="#legacysandbox" aria-label="Permalink to &quot;legacySandbox&quot;">​</a></h4><p>单例，跟快照沙箱差不多，也会污染 window，但是性能比快照好</p><h4 id="proxysandbox" tabindex="-1">ProxySandbox <a class="header-anchor" href="#proxysandbox" aria-label="Permalink to &quot;ProxySandbox&quot;">​</a></h4><p>创建了 fakeWindow，set 操作都在 fakeWindow 上，取值优先从 fakeWindow 上取，不会污染 window，且支持多例</p><p>需要注意对于 window 的拷贝是浅拷贝，一些对象属性如 history，主子应用是共用的</p><h2 id="qiankun-是怎么做-css-隔离的" tabindex="-1">qiankun 是怎么做 css 隔离的 <a class="header-anchor" href="#qiankun-是怎么做-css-隔离的" aria-label="Permalink to &quot;qiankun 是怎么做 css 隔离的&quot;">​</a></h2><p>sandbox 参数，有两个是关于 css 的，strictStyleIsolation 默认 false、experimentalStyleIsolation 默认 false</p><p>strictStyleIsolation 为 true 时，用 shadowDom 隔离，shadowDom 的特点是：</p><ul><li>影子节点内的导入样式不会影响外层</li><li>mode 为 closed 时，外层无法获取影子节点内的元素</li><li>影子节点内的元素样式会继承其宿主元素的样式</li><li>影子节点内的元素无法被外层选择器选中</li></ul><p>experimentalStyleIsolation 为 true 时，类似 vue 的 scoped 实现，通过属性选择器隔离</p>`,20),e=[o];function t(r,c,y,i,b,d){return a(),n("div",null,e)}const f=s(p,[["render",t]]);export{m as __pageData,f as default};
